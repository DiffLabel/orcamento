<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Proposta Comercial – Diff Label</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 960px;
      background: #f5f5f5;
    }
    .wrapper {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    /* Estilo chamativo e cor vermelha para a textarea de OBS gerais */
    #obsGerais {
      color: red;
      font-weight: bold;
      font-size: 16px;
      border-color: #e74c3c;
      background-color: #fdecea;
      max-width: 90%; /* diminui largura para caber no PDF */
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .item {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      background: #fafafa;
    }
    .item h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      color: #333;
    }
    button {
      margin-top: 15px;
      padding: 12px 20px;
      background-color: #1a73e8;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #0f5cc8;
    }
    a#btnWhats {
      display: none;
      margin-top: 15px;
      text-align: center;
      text-decoration: none;
      background-color: #25D366;
      color: white;
      padding: 12px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 16px;
    }
    a#btnWhats:hover {
      background-color: #1ebe5c;
    }
    #resultado {
      margin-top: 20px;
      padding: 15px;
      background: #eef;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.5;
    }
    .section-divider {
      border-top: 1px solid #ccc;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Proposta Comercial</h1>

    <label>Nº do Orçamento:</label>
    <input type="text" id="numOrcamento" readonly />

    <label>Nome do Cliente:</label>
    <input type="text" id="nomeCliente" required />

    <label>CNPJ:</label>
    <input type="text" id="cnpjCliente" placeholder="Somente números" />

    <label>Telefone:</label>
    <input type="text" id="telefoneCliente" placeholder="Somente números" />

    <label>E-mail:</label>
    <input type="email" id="emailCliente" required />

    <div id="itensContainer"></div>
    <button onclick="adicionarItem()">Adicionar Item</button>

    <!-- Termos e Condições editáveis -->
    <div class="section-divider"></div>
    <h2>Termos e Condições de Venda</h2>
    <label>Validade da Proposta (fixo “10 dias”):</label>
    <input type="text" id="validadeProposta" value="10 dias" />

    <label>Prazo de Entrega (dias úteis):</label>
    <select id="prazoEntrega">
      <option>3/4</option>
      <option>5/6</option>
      <option>7/8</option>
      <option>9/10</option>
    </select>

    <label>Condição de Pagamento:</label>
    <select id="condPagamento">
      <option>À vista</option>
      <option>14dd</option>
      <option>21dd</option>
      <option>28dd</option>
      <option>14/28dd</option>
      <option>35dd</option>
    </select>

    <label>Frete:</label>
    <select id="frete">
      <option>FOB</option>
      <option>CIF</option>
    </select>

    <label>Contato Comercial:</label>
    <input type="text" id="contatoComercial" value="pedro@diffembalagens.com.br" />

    <!-- Observações gerais -->
    <div class="section-divider"></div>
    <h2>OBS:</h2>
    <textarea id="obsGerais">
Para agilizar a impressão, pedimos que arquivos sejam enviados em pdf vetorizado;
Para impressão em Bopp Metalizado/Transparente o arquivo recebido pela Diff deve conter o mapa de branco, caso contrário será adicionado 1 dia a mais no prazo de entrega;
A Diff só se responsabiliza por cores exatas de trabalho, quando a mesma receber amostra física ou prova de cor do cliente;
A impressão só será feita após aprovação por e-mail do arquivo: "layout de aprovação";
Prazo de Entrega começa a contar após aprovação do "Layout de aprovação";
Haverá atualização de valor, caso formato/quantidade final do rótulo seja diferente do proposto inicialmente.
    </textarea>

    <div class="section-divider"></div>

    <button onclick="calcularOrcamento()">Calcular Orçamento + Gerar PDF</button>
    <button onclick="gerarPDF()">Gerar PDF (sem recálculo)</button>
    <a id="btnWhats" target="_blank">Enviar via WhatsApp</a>

    <div id="resultado"></div>
  </div>

  <script>
    let contador = 0;
    const imagens = [];
    const materiais = [
      "Ad Couche",
      "Bopp Branco Fosco",
      "Bopp Brilho",
      "Bopp Metalizado",
      "Bopp Transparente",
      "Bopp Holográfico",
      "Vinil Fosco",
      "Vinil Amarelo",
      "Vinil Preto",
      "Vinil Brilho",
      "Vinil Refletivo",
      "Vinil Transparente"
    ];
    const acabamentos = [
      "Em Cartela",
      "Em Rolo/Bobina",
      "Rolo/Bobina com Laminação Fosca",
      "Rolo/Bobina com Laminação Brilho"
    ];
    const colas = [
      "Cola Acrílica",
      "Cola Borracha",
      "Cola Removível"
    ];
    const cores = [
      "1x0 (Preto)",
      "4x0 (CMYK)",
      "5x0 (CMYK + Branco)"
    ];

    function gerarNumeroOrcamento() {
      let ultimoNumero = localStorage.getItem('ultimoOrcamento') || 0;
      ultimoNumero = parseInt(ultimoNumero) + 1;
      localStorage.setItem('ultimoOrcamento', ultimoNumero);
      document.getElementById('numOrcamento').value = String(ultimoNumero).padStart(5, '0');
    }

    function criarSelect(options) {
      return options.map(o => `<option>${o}</option>`).join("");
    }

    function adicionarItem() {
      const container = document.getElementById("itensContainer");
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <h3>Item ${contador + 1}</h3>
        <label>Material:</label>
        <select class="material">${criarSelect(materiais)}</select>
        <label>Acabamento:</label>
        <select class="acabamento">${criarSelect(acabamentos)}</select>
        <label>Tipo de Cola:</label>
        <select class="cola">${criarSelect(colas)}</select>
        <label>Cores:</label>
        <select class="cores">${criarSelect(cores)}</select>
        <label>Largura (mm):</label>
        <input type="number" class="largura" required />
        <label>Altura (mm):</label>
        <input type="number" class="altura" required />
        <label>Quantidade:</label>
        <input type="number" class="quantidade" required />
        <label>Preço por m² (R$):</label>
        <input type="number" class="preco" step="0.01" required />
        <label>SKU:</label>
        <input type="text" class="sku" />
        <label>Observação:</label>
        <textarea class="obs" rows="2"></textarea>
        <label>Arte (imagem):</label>
        <input type="file" class="arte" accept="image/*" onchange="carregarImagem(this, ${contador})" />
      `;
      container.appendChild(div);
      imagens.push(null);
      contador++;
    }

    function carregarImagem(input, index) {
      const reader = new FileReader();
      reader.onload = () => imagens[index] = reader.result;
      if (input.files[0]) reader.readAsDataURL(input.files[0]);
    }

    // Formata CNPJ: 00000000000000 → 00.000.000/0000-00
    function formatarCNPJ(cnpj) {
      const nums = cnpj.replace(/\D/g, "").padStart(14, "0");
      return `${nums.slice(0,2)}.${nums.slice(2,5)}.${nums.slice(5,8)}/${nums.slice(8,12)}-${nums.slice(12)}`;
    }

    // Formata telefone: 47988081212 → (47) 98808-1212
    function formatarTelefone(tel) {
      const nums = tel.replace(/\D/g, "").padStart(10, "0");
      const ddd = nums.slice(0,2);
      const part1 = nums.slice(2,7);
      const part2 = nums.slice(7);
      return `(${ddd}) ${part1}-${part2}`;
    }

    function calcularOrcamento() {
      renderizarResultado();       // Atualiza a exibição na página
      gerarLinkWhatsApp();         // Exibe o link de envio
      gerarPDF();                  // Gera o PDF
    }

    function renderizarResultado() {
      const nome = document.getElementById("nomeCliente").value || "-";
      const cnpjRaw = document.getElementById("cnpjCliente").value || "";
      const cnpj = cnpjRaw ? formatarCNPJ(cnpjRaw) : "-";
      const telRaw = document.getElementById("telefoneCliente").value || "";
      const tel = telRaw ? formatarTelefone(telRaw) : "-";
      const email = document.getElementById("emailCliente").value || "-";
      const numOrcamento = document.getElementById("numOrcamento").value;
      const data = new Date().toLocaleDateString('pt-BR');
      const itens = document.querySelectorAll(".item");
      let totalGeral = 0;

      let resultadoHTML = `
        <h3>Proposta Comercial ${numOrcamento}</h3>
        <p><strong>Data:</strong> ${data}</p>
        <p>
          <strong>Cliente:</strong> ${nome} | 
          <strong>CNPJ:</strong> ${cnpj} | 
          <strong>Telefone:</strong> ${tel} | 
          <strong>E-mail:</strong> ${email}
        </p>
        <div style="overflow-x:auto; margin-top: 10px;">
        <table style="width:100%; border-collapse: collapse;">
          <thead style="background-color: #dddddd;">
            <tr>
              <th style="border: 1px solid #bbb; padding: 6px;">Itens</th>
              <th style="border: 1px solid #bbb; padding: 6px;">Descrição dos Produtos</th>
              <th style="border: 1px solid #bbb; padding: 6px;">Qtd.</th>
              <th style="border: 1px solid #bbb; padding: 6px;">Un.</th>
              <th style="border: 1px solid #bbb; padding: 6px;">Preço c/ Impostos (R$)</th>
              <th style="border: 1px solid #bbb; padding: 6px;">Total (R$)</th>
            </tr>
          </thead>
          <tbody>
      `;

      itens.forEach((item, i) => {
        const material = item.querySelector(".material").value;
        const acabamento = item.querySelector(".acabamento").value;
        const cola = item.querySelector(".cola").value;
        const cor = item.querySelector(".cores").value;
        const larguraInput = parseFloat(item.querySelector(".largura").value);
        const alturaInput = parseFloat(item.querySelector(".altura").value);
        const largura = isNaN(larguraInput) ? 0 : larguraInput + 3;
        const altura = isNaN(alturaInput) ? 0 : alturaInput + 3;
        const qtdeInput = parseInt(item.querySelector(".quantidade").value);
        const qtde = isNaN(qtdeInput) ? 0 : qtdeInput;
        const precoInput = parseFloat(item.querySelector(".preco").value);
        const preco = isNaN(precoInput) ? 0 : precoInput;
        const sku = item.querySelector(".sku").value || "-";
        const obs = item.querySelector(".obs").value;
        const area = (largura * altura) / 1000000; // mm → m²
        const areaTotal = area * qtde;
        const valorTotal = (material.includes("Vinil") && areaTotal < 5 && qtde <= 2000)
          ? 225
          : areaTotal * preco;
        const valorUnitario = qtde > 0 ? (valorTotal / qtde).toFixed(4) : "0.0000";

        totalGeral += valorTotal;

        resultadoHTML += `
          <tr>
            <td style="border: 1px solid #bbb; padding: 6px; text-align: center;">${i+1}</td>
            <td style="border: 1px solid #bbb; padding: 6px; vertical-align: top;">
              <strong>Remox ${i+1}</strong><br>
              Material: ${material}<br>
              Formato: ${largura.toFixed(0)}×${altura.toFixed(0)} mm<br>
              SKU: ${sku}<br>
              Cores: ${cor}<br>
              Acab: ${acabamento}
            </td>
            <td style="border: 1px solid #bbb; padding: 6px; text-align: center;">${qtde}</td>
            <td style="border: 1px solid #bbb; padding: 6px; text-align: center;">Un.</td>
            <td style="border: 1px solid #bbb; padding: 6px; text-align: right;">R$ ${valorUnitario}</td>
            <td style="border: 1px solid #bbb; padding: 6px; text-align: right;">R$ ${valorTotal.toFixed(2)}</td>
          </tr>
        `;
      });

      resultadoHTML += `
          </tbody>
        </table>
        </div>
        <h4 style="text-align: right; margin-top: 10px;">TOTAL R$: R$ ${totalGeral.toFixed(2)}</h4>
        <div style="background-color: #f2f2f2; padding: 8px; margin-top: 10px;">
          <strong>OBS:</strong>
        </div>
        <div class="section-divider"></div>
      `;

      // Termos e Condições e OBS gerais
      const validade = document.getElementById("validadeProposta").value;
      const prazoEntrega = document.getElementById("prazoEntrega").value;
      const condPagamento = document.getElementById("condPagamento").value;
      const frete = document.getElementById("frete").value;
      const contato = document.getElementById("contatoComercial").value;
      const obsGerais = document.getElementById("obsGerais").value.replace(/\n/g, "<br>");

      resultadoHTML += `
        <div style="background-color: #dddddd; padding: 8px; margin-top: 10px;">
          <strong>TERMOS E CONDIÇÕES DE VENDA</strong>
        </div>
        <table style="width:100%; margin-top: 6px; font-size: 14px;">
          <tr><td><strong>Validade da Proposta:</strong></td><td>${validade}</td></tr>
          <tr><td><strong>Prazo de Entrega (dias úteis):</strong></td><td>${prazoEntrega}</td></tr>
          <tr><td><strong>Condição de Pagamento:</strong></td><td>${condPagamento}</td></tr>
          <tr><td><strong>Frete:</strong></td><td>${frete}</td></tr>
          <tr><td><strong>Contato Comercial:</strong></td><td>${contato}</td></tr>
        </table>
        <div class="section-divider"></div>
        <div style="background-color: #f9e6e6; color: red; font-weight: bold; padding: 8px; margin-top: 10px; max-width: 90%;">
          * Para agilizar a impressão, pedimos que arquivos sejam enviados em pdf vetorizado;<br>
          * Para impressão em Bopp Metalizado/Transparente o arquivo recebido pela Diff deve conter o mapa de branco, caso contrário será adicionado 1 dia a mais no prazo de entrega;<br>
          * A Diff só se responsabiliza por cores exatas de trabalho, quando a mesma receber amostra física ou prova de cor do cliente;<br>
          * A impressão só será feita após aprovação por e-mail do arquivo: "layout de aprovação";<br>
          * Prazo de Entrega começa a contar após aprovação do "Layout de aprovação";<br>
          * Haverá atualização de valor, caso formato/quantidade final do rótulo seja diferente do proposto inicialmente.
        </div>
      `;

      document.getElementById("resultado").innerHTML = resultadoHTML;
    }

    function gerarLinkWhatsApp() {
      const numOrcamento = document.getElementById("numOrcamento").value;
      const nome = document.getElementById("nomeCliente").value;
      const itens = document.querySelectorAll(".item");
      let texto = `Proposta Comercial #${numOrcamento}%0ACliente: ${nome}%0A`;

      itens.forEach((item, i) => {
        const material = item.querySelector(".material").value;
        const acabamento = item.querySelector(".acabamento").value;
        const cola = item.querySelector(".cola").value;
        const cor = item.querySelector(".cores").value;
        const larguraInput = parseFloat(item.querySelector(".largura").value);
        const alturaInput = parseFloat(item.querySelector(".altura").value);
        const largura = isNaN(larguraInput) ? 0 : larguraInput + 3;
        const altura = isNaN(alturaInput) ? 0 : alturaInput + 3;
        const qtdeInput = parseInt(item.querySelector(".quantidade").value);
        const qtde = isNaN(qtdeInput) ? 0 : qtdeInput;
        const precoInput = parseFloat(item.querySelector(".preco").value);
        const preco = isNaN(precoInput) ? 0 : precoInput;
        const sku = item.querySelector(".sku").value || "-";
        const obs = item.querySelector(".obs").value;
        const area = (largura * altura) / 1000000;
        const areaTotal = area * qtde;
        const valorTotal = (material.includes("Vinil") && areaTotal < 5 && qtde <= 2000)
          ? 225
          : areaTotal * preco;
        const valorUnitario = qtde > 0 ? (valorTotal / qtde).toFixed(4) : "0.0000";

        texto += `Item ${i+1}:%0A• Material: ${material}%0A• Formato: ${largura.toFixed(0)}×${altura.toFixed(0)} mm%0A• SKU: ${sku}%0A• Cores: ${cor}%0A• Acab: ${acabamento}%0A• Qtde: ${qtde}%0A• Un.: Un%0A• Valor Unitário: R$ ${valorUnitario}%0A• Total: R$ ${valorTotal.toFixed(2)}`;
        if (obs) texto += `%0A• Obs: ${obs}`;
        texto += `%0A%0A`;
      });

      // Termos e Condições e OBS gerais no WhatsApp
      const validade = document.getElementById("validadeProposta").value;
      const prazoEntrega = document.getElementById("prazoEntrega").value;
      const condPagamento = document.getElementById("condPagamento").value;
      const frete = document.getElementById("frete").value;
      const contato = document.getElementById("contatoComercial").value;
      const obsGerais = document.getElementById("obsGerais").value.split("\n").join("%0A");

      texto += `TERMOS E CONDIÇÕES DE VENDA:%0A• Validade da Proposta: ${validade}%0A• Prazo de Entrega: ${prazoEntrega}%0A• Condição de Pagamento: ${condPagamento}%0A• Frete: ${frete}%0A• Contato Comercial: ${contato}%0A%0AOBS:%0A${encodeURI(obsGerais)}%0A`;

      texto = encodeURI(texto.trim());
      const url = `https://wa.me/?text=${texto}`;
      const btn = document.getElementById("btnWhats");
      btn.href = url;
      btn.style.display = "block";
    }

    async function gerarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const larguraPagina = doc.internal.pageSize.getWidth();
      const margem = 40;
      const larguraUtil = larguraPagina - margem * 2;

      // Resgata e formata dados do cliente
      const nome = document.getElementById("nomeCliente").value || "-";
      const cnpjRaw = document.getElementById("cnpjCliente").value || "";
      const cnpj = cnpjRaw ? formatarCNPJ(cnpjRaw) : "-";
      const telRaw = document.getElementById("telefoneCliente").value || "";
      const tel = telRaw ? formatarTelefone(telRaw) : "-";
      const email = document.getElementById("emailCliente").value || "-";
      const numOrcamento = document.getElementById("numOrcamento").value;
      const data = new Date().toLocaleDateString('pt-BR');

      // ------------------------------------------------------------
      // 1) Cabeçalho
      // ------------------------------------------------------------
      doc.setFontSize(16);
      doc.setFont("Helvetica", "bold");
      doc.text("PROPOSTA COMERCIAL " + numOrcamento, larguraPagina / 2, 40, { align: "center" });

      // Linha horizontal abaixo do título
      doc.setLineWidth(1);
      doc.setDrawColor(0);
      doc.line(margem, 50, larguraPagina - margem, 50);

      // Logo placeholder (círculo amarelo) à esquerda
      doc.setFillColor(255, 204, 0);
      doc.circle(margem + 40, 90, 30, 'F');
      doc.setFontSize(12);
      doc.setFont("Helvetica", "bold");
      doc.text("diff.", margem + 70, 100);
      doc.setFontSize(10);
      doc.text("Label", margem + 70, 115);

      // Informações da empresa à direita
      const empresaLinhas = [
        "DIFF EMBALAGENS ESPECIAIS",
        "R: Pomerode, 1371 - Bairro Salto do Norte - 89065-300 - Blumenau/SC",
        "CNPJ: 18.678.030/0001-17   IE: 260.482.544",
        "FONE: (47) 98808-1212 / (47) 3304-1600"
      ];
      doc.setFontSize(10);
      doc.setFont("Helvetica", "normal");
      let yTexto = 80;
      empresaLinhas.forEach(linha => {
        doc.text(linha, larguraPagina - margem, yTexto, { align: "right" });
        yTexto += 12;
      });

      // Linha separadora abaixo do cabeçalho
      doc.setLineWidth(1);
      doc.line(margem, yTexto + 4, larguraPagina - margem, yTexto + 4);
      let y = yTexto + 20;

      // ------------------------------------------------------------
      // 2) Dados do cliente
      // ------------------------------------------------------------
      doc.setFontSize(10);
      doc.setFont("Helvetica", "bold");
      doc.text("Cliente:", margem, y);
      doc.setFont("Helvetica", "normal");
      doc.text(nome, margem + 50, y);
      y += 14;
      doc.setFont("Helvetica", "bold");
      doc.text("CNPJ:", margem, y);
      doc.setFont("Helvetica", "normal");
      doc.text(cnpj, margem + 30, y);
      y += 14;
      doc.setFont("Helvetica", "bold");
      doc.text("Telefone:", margem, y);
      doc.setFont("Helvetica", "normal");
      doc.text(tel, margem + 60, y);
      y += 14;
      doc.setFont("Helvetica", "bold");
      doc.text("E-mail:", margem, y);
      doc.setFont("Helvetica", "normal");
      doc.text(email, margem + 40, y);
      y += 20;

      // ------------------------------------------------------------
      // 3) Tabela de Itens
      // ------------------------------------------------------------
      // Definição de larguras de colunas
      const colWidths = [
        30,
        larguraUtil * 0.45,
        40,
        30,
        90,
        70
      ];
      let x = margem;

      // Cabeçalho da tabela
      const headerBgColor = "#dddddd";
      doc.setFillColor(headerBgColor);
      doc.setDrawColor(0);
      doc.setLineWidth(0.5);
      doc.setFontSize(9);
      doc.setFont("Helvetica", "bold");

      doc.rect(x, y, colWidths[0], 20, "F");
      doc.rect(x + colWidths[0], y, colWidths[1], 20, "F");
      doc.rect(x + colWidths[0] + colWidths[1], y, colWidths[2], 20, "F");
      doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], 20, "F");
      doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], 20, "F");
      doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], 20, "F");

      doc.text("Itens", x + 5, y + 13);
      doc.text("Descrição dos Produtos", x + colWidths[0] + 5, y + 13);
      doc.text("Qtd.", x + colWidths[0] + colWidths[1] + 5, y + 13);
      doc.text("Un.", x + colWidths[0] + colWidths[1] + colWidths[2] + 5, y + 13);
      doc.text("Preço c/ Impostos (R$)", x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 5, y + 13);
      doc.text("Total (R$)", x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 5, y + 13);

      y += 22;
      doc.setFont("Helvetica", "normal");
      let totalGeral = 0;

      document.querySelectorAll(".item").forEach((item, i) => {
        const material = item.querySelector(".material").value;
        const acabamento = item.querySelector(".acabamento").value;
        const cola = item.querySelector(".cola").value;
        const cor = item.querySelector(".cores").value;
        const larguraInput = parseFloat(item.querySelector(".largura").value);
        const alturaInput = parseFloat(item.querySelector(".altura").value);
        const largura = isNaN(larguraInput) ? 0 : larguraInput + 3;
        const altura = isNaN(alturaInput) ? 0 : alturaInput + 3;
        const qtdeInput = parseInt(item.querySelector(".quantidade").value);
        const qtde = isNaN(qtdeInput) ? 0 : qtdeInput;
        const precoInput = parseFloat(item.querySelector(".preco").value);
        const preco = isNaN(precoInput) ? 0 : precoInput;
        const sku = item.querySelector(".sku").value || "-";
        const obs = item.querySelector(".obs").value;
        const area = (largura * altura) / 1000000;
        const areaTotal = area * qtde;
        const valorTotal = (material.includes("Vinil") && areaTotal < 5 && qtde <= 2000)
          ? 225
          : areaTotal * preco;
        const valorUnitario = qtde > 0 ? (valorTotal / qtde).toFixed(4) : "0.0000";

        totalGeral += valorTotal;

        // Determina quantas linhas a descrição vai ocupar (para altura dinâmica)
        const descText = `Remox ${i+1}\nMaterial: ${material}\nFormato: ${largura.toFixed(0)}×${altura.toFixed(0)} mm\nSKU: ${sku}\nCores: ${cor}\nAcab: ${acabamento}`;
        const descLines = doc.splitTextToSize(descText, colWidths[1] - 10);
        const lineHeight = 12;
        const rowHeight = descLines.length * lineHeight + 10; // +10 para espaçamento extra

        // Se ultrapassar próximo da margem inferior, cria nova página
        if (y + rowHeight > 740) {
          doc.addPage();
          y = 40;
        }

        // Coluna "Itens"
        doc.setFont("Helvetica", "bold");
        doc.text(String(i+1), x + 5, y + 10);
        doc.setFont("Helvetica", "normal");

        // Coluna "Descrição dos Produtos"
        doc.text(descLines, x + colWidths[0] + 5, y + 10);

        // Coluna "Qtd."
        doc.text(String(qtde), x + colWidths[0] + colWidths[1] + 15, y + 10);

        // Coluna "Un."
        doc.text("Un.", x + colWidths[0] + colWidths[1] + colWidths[2] + 5, y + 10);

        // Coluna "Preço c/ Impostos"
        doc.text(`R$ ${valorUnitario}`, x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 5, y + 10);

        // Coluna "Total (R$)"
        doc.text(`R$ ${valorTotal.toFixed(2)}`, x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 5, y + 10);

        // Desenha retângulo para a linha inteira com altura adaptativa
        doc.setLineWidth(0.5);
        doc.rect(margem, y - 2, larguraUtil, rowHeight, "S");

        y += rowHeight + 4;
      });

      // Total Geral
      if (y > 700) {
        doc.addPage();
        y = 40;
      }
      doc.setFont("Helvetica", "bold");
      doc.setFontSize(12);
      doc.text(`TOTAL R$: R$ ${totalGeral.toFixed(2)}`, margem + larguraUtil - 150, y + 10, { align: "left" });
      y += 30;

      // ------------------------------------------------------------
      // 4) Termos e Condições & OBS no final do PDF
      // ------------------------------------------------------------
      if (y > 700) {
        doc.addPage();
        y = 40;
      }

      // Linha antes dos termos
      doc.setLineWidth(0.5);
      doc.line(margem, y, larguraPagina - margem, y);
      y += 12;

      const validade = document.getElementById("validadeProposta").value;
      const prazoEntrega = document.getElementById("prazoEntrega").value;
      const condPagamento = document.getElementById("condPagamento").value;
      const frete = document.getElementById("frete").value;
      const contato = document.getElementById("contatoComercial").value;
      const obsGerais = document.getElementById("obsGerais").value.split("\n");

      doc.setFont("Helvetica", "bold");
      doc.setFontSize(12);
      doc.text("TERMOS E CONDIÇÕES DE VENDA", margem, y);
      y += 16;

      doc.setFont("Helvetica", "normal");
      doc.setFontSize(10);
      doc.text(`Validade da Proposta: ${validade}`, margem, y); y += 12;
      doc.text(`Prazo de Entrega (dias úteis): ${prazoEntrega}`, margem, y); y += 12;
      doc.text(`Condição de Pagamento: ${condPagamento}`, margem, y); y += 12;
      doc.text(`Frete: ${frete}`, margem, y); y += 12;
      doc.text(`Contato Comercial: ${contato}`, margem, y); y += 20;

      if (y > 700) {
        doc.addPage();
        y = 40;
      }
      // Linha antes das observações
      doc.setLineWidth(0.5);
      doc.line(margem, y, larguraPagina - margem, y);
      y += 12;

      // OBS gerais em vermelho, largura reduzida (90% da área útil)
      doc.setFont("Helvetica", "bold");
      doc.setFontSize(11);
      doc.setTextColor(255, 0, 0);
      doc.text("OBS:", margem, y); y += 14;

      doc.setFont("Helvetica", "normal");
      doc.setFontSize(10);
      const obsWidth = (larguraUtil * 0.9);
      obsGerais.forEach(line => {
        if (y > 700) {
          doc.addPage();
          y = 40;
        }
        const wrapped = doc.splitTextToSize(line, obsWidth);
        doc.text(wrapped, margem + 5, y);
        y += wrapped.length * 12;
      });

      if (y > 700) {
        doc.addPage();
        y = 40;
      }
      // Linha final
      doc.setTextColor(0, 0, 0);
      doc.setLineWidth(0.5);
      doc.line(margem, y + 10, larguraPagina - margem, y + 10);

      doc.save(`Proposta_Comercial_${numOrcamento}.pdf`);
    }

    window.onload = () => {
      gerarNumeroOrcamento();
      adicionarItem(); // já cria o primeiro item
    };
  </script>
</body>
</html>
