<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Orçamento com Arte – Diff Label</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      max-width: 960px; 
      background: #f5f5f5;
    }
    .wrapper {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; margin-bottom: 20px; }
    label { display: block; margin-top: 12px; font-weight: bold; }
    input, select, textarea { 
      width: 100%; 
      padding: 8px; 
      margin-top: 4px; 
      border: 1px solid #ccc; 
      border-radius: 4px; 
      font-size: 14px; 
      box-sizing: border-box;
    }
    /* Estilo chamativo e cor vermelha para a textarea de OBS gerais */
    #obsGerais {
      color: red;
      font-weight: bold;
      font-size: 16px;
      border-color: #e74c3c;
      background-color: #fdecea;
    }
    textarea { resize: vertical; min-height: 60px; }
    .item {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      background: #fafafa;
    }
    .item h3 { margin-top: 0; margin-bottom: 10px; font-size: 18px; color: #333; }
    button {
      margin-top: 15px;
      padding: 12px 20px;
      background-color: #1a73e8;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:hover { background-color: #0f5cc8; }
    a#btnWhats {
      display: none;
      margin-top: 15px;
      text-align: center;
      text-decoration: none;
      background-color: #25D366;
      color: white;
      padding: 12px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 16px;
    }
    a#btnWhats:hover { background-color: #1ebe5c; }
    #resultado {
      margin-top: 20px;
      padding: 15px;
      background: #eef;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.5;
    }
    .section-divider {
      border-top: 1px solid #ccc;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Orçamento com Arte – Diff Label</h1>

    <label>Nº do Orçamento:</label>
    <input type="text" id="numOrcamento" readonly />

    <label>Nome do Cliente:</label>
    <input type="text" id="nomeCliente" required />

    <label>E-mail:</label>
    <input type="email" id="emailCliente" required />

    <div id="itensContainer"></div>
    <button onclick="adicionarItem()">Adicionar Item</button>

    <!-- Termos e Condições editáveis -->
    <div class="section-divider"></div>
    <h2>Termos e Condições de Venda</h2>
    <label>Validade da Proposta (fixo “10 dias”):</label>
    <input type="text" id="validadeProposta" value="10 dias" />

    <label>Prazo de Entrega (dias úteis):</label>
    <select id="prazoEntrega">
      <option>3/4</option>
      <option>5/6</option>
      <option>7/8</option>
      <option>9/10</option>
    </select>

    <label>Condição de Pagamento:</label>
    <select id="condPagamento">
      <option>À vista</option>
      <option>14dd</option>
      <option>21dd</option>
      <option>28dd</option>
      <option>14/28dd</option>
      <option>35dd</option>
    </select>

    <label>Frete:</label>
    <select id="frete">
      <option>FOB</option>
      <option>CIF</option>
    </select>

    <label>Contato Comercial:</label>
    <input type="text" id="contatoComercial" value="pedro@diffembalagens.com.br" />

    <!-- Observações gerais -->
    <div class="section-divider"></div>
    <h2>OBS:</h2>
    <textarea id="obsGerais">
Para agilizar a impressão, pedimos que arquivos sejam enviados em pdf vetorizado;
Para impressão em Bopp Metalizado/Transparente o arquivo recebido pela Diff deve conter o mapa de branco, caso contrário será adicionado 1 dia a mais no prazo de entrega;
A Diff só se responsabiliza por cores exatas de trabalho, quando a mesma receber amostra física ou prova de cor do cliente;
A impressão só será feita após aprovação por e-mail do arquivo: "layout de aprovação";
Prazo de Entrega começa a contar após aprovação do "Layout de aprovação";
Haverá atualização de valor, caso formato/quantidade final do rótulo seja diferente do proposto inicialmente.
    </textarea>

    <div class="section-divider"></div>

    <button onclick="calcularOrcamento()">Calcular Orçamento + Gerar PDF</button>
    <button onclick="gerarPDF()">Gerar PDF (sem recálculo)</button>
    <a id="btnWhats" target="_blank">Enviar via WhatsApp</a>

    <div id="resultado"></div>
  </div>

  <script>
    let contador = 0;
    const imagens = [];
    const materiais = [
      "Ad Couche",
      "Bopp Branco Fosco",
      "Bopp Brilho",
      "Bopp Metalizado",
      "Bopp Transparente",
      "Bopp Holográfico",
      "Vinil Fosco",
      "Vinil Amarelo",
      "Vinil Preto",
      "Vinil Brilho",
      "Vinil Refletivo",
      "Vinil Transparente"
    ];
    const acabamentos = [
      "Em Cartela",
      "Em Rolo/Bobina",
      "Rolo/Bobina com Laminação Fosca",
      "Rolo/Bobina com Laminação Brilho"
    ];
    const colas = ["Cola Acrílica", "Cola Borracha", "Cola Removível"];
    const cores = ["1x0 (Preto)", "4x0 (CMYK)", "5x0 (CMYK + Branco)"];

    function gerarNumeroOrcamento() {
      let ultimoNumero = localStorage.getItem('ultimoOrcamento') || 0;
      ultimoNumero = parseInt(ultimoNumero) + 1;
      localStorage.setItem('ultimoOrcamento', ultimoNumero);
      document.getElementById('numOrcamento').value = String(ultimoNumero).padStart(4, '0');
    }

    function criarSelect(options) {
      return options.map(o => `<option>${o}</option>`).join("");
    }

    function adicionarItem() {
      const container = document.getElementById("itensContainer");
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <h3>Item ${contador + 1}</h3>
        <label>Material:</label>
        <select class="material">${criarSelect(materiais)}</select>
        <label>Acabamento:</label>
        <select class="acabamento">${criarSelect(acabamentos)}</select>
        <label>Tipo de Cola:</label>
        <select class="cola">${criarSelect(colas)}</select>
        <label>Cores:</label>
        <select class="cores">${criarSelect(cores)}</select>
        <label>Largura (mm):</label>
        <input type="number" class="largura" required />
        <label>Altura (mm):</label>
        <input type="number" class="altura" required />
        <label>Quantidade:</label>
        <input type="number" class="quantidade" required />
        <label>Preço por m² (R$):</label>
        <input type="number" class="preco" step="0.01" required />
        <label>Observação:</label>
        <textarea class="obs"></textarea>
        <label>Arte (imagem):</label>
        <input type="file" class="arte" accept="image/*" onchange="carregarImagem(this, ${contador})" />
      `;
      container.appendChild(div);
      imagens.push(null);
      contador++;
    }

    function carregarImagem(input, index) {
      const reader = new FileReader();
      reader.onload = () => imagens[index] = reader.result;
      if (input.files[0]) reader.readAsDataURL(input.files[0]);
    }

    function calcularOrcamento() {
      renderizarResultado();       // Atualiza a exibição na página
      gerarLinkWhatsApp();         // Exibe o link de envio
      gerarPDF();                  // Gera o PDF
    }

    function renderizarResultado() {
      const nome = document.getElementById("nomeCliente").value;
      const email = document.getElementById("emailCliente").value;
      const numOrcamento = document.getElementById("numOrcamento").value;
      const itens = document.querySelectorAll(".item");
      let totalGeral = 0;
      let resultadoHTML = `
        <h3>Orçamento #${numOrcamento}</h3>
        <p>Cliente: ${nome}<br>Email: ${email}</p>
        <ul>
      `;

      itens.forEach((item, i) => {
        const material = item.querySelector(".material").value;
        const acabamento = item.querySelector(".acabamento").value;
        const cola = item.querySelector(".cola").value;
        const cor = item.querySelector(".cores").value;
        const largura = parseFloat(item.querySelector(".largura").value) + 3;
        const altura = parseFloat(item.querySelector(".altura").value) + 3;
        const qtde = parseInt(item.querySelector(".quantidade").value);
        const preco = parseFloat(item.querySelector(".preco").value);
        const obs = item.querySelector(".obs").value;
        const area = (largura * altura) / 1000000; // mm → m²
        const areaTotal = area * qtde;
        const valorTotal = (material.includes("Vinil") && areaTotal < 5 && qtde <= 2000)
          ? 225
          : areaTotal * preco;
        const valorUnitario = (valorTotal / qtde).toFixed(4);

        totalGeral += valorTotal;

        resultadoHTML += `
          <li>
            <strong>Item ${i + 1}</strong><br>
            Material: ${material}<br>
            Acabamento: ${acabamento}<br>
            Tipo de Cola: ${cola}<br>
            Cores: ${cor}<br>
            Largura: ${largura} mm<br>
            Altura: ${altura} mm<br>
            Quantidade: ${qtde}<br>
            <strong>Valor Unitário: R$ ${valorUnitario}</strong><br>
            <strong>Valor Total do Item: R$ ${valorTotal.toFixed(2)}</strong><br>
            <em>Observação: ${obs}</em>
          </li><br>
        `;
      });

      // Termos e Condições e OBS gerais
      const validade = document.getElementById("validadeProposta").value;
      const prazoEntrega = document.getElementById("prazoEntrega").value;
      const condPagamento = document.getElementById("condPagamento").value;
      const frete = document.getElementById("frete").value;
      const contato = document.getElementById("contatoComercial").value;
      const obsGerais = document.getElementById("obsGerais").value.replace(/\n/g, "<br>");

      resultadoHTML += `</ul><h4>Total Geral: R$ ${totalGeral.toFixed(2)}</h4>`;
      resultadoHTML += `
        <div class="section-divider"></div>
        <h2>Termos e Condições de Venda</h2>
        <p>Validade da Proposta: ${validade}</p>
        <p>Prazo de Entrega (dias úteis): ${prazoEntrega}</p>
        <p>Condição de Pagamento: ${condPagamento}</p>
        <p>Frete: ${frete}</p>
        <p>Contato Comercial: ${contato}</p>
        <div class="section-divider"></div>
        <h2>OBS:</h2>
        <p>${obsGerais}</p>
        <div class="section-divider"></div>
      `;

      document.getElementById("resultado").innerHTML = resultadoHTML;
    }

    function gerarLinkWhatsApp() {
      const numOrcamento = document.getElementById("numOrcamento").value;
      const nome = document.getElementById("nomeCliente").value;
      const itens = document.querySelectorAll(".item");
      let texto = `Orçamento #${numOrcamento}%0ACliente: ${nome}%0A`;

      itens.forEach((item, i) => {
        const material = item.querySelector(".material").value;
        const acabamento = item.querySelector(".acabamento").value;
        const cola = item.querySelector(".cola").value;
        const cor = item.querySelector(".cores").value;
        const largura = parseFloat(item.querySelector(".largura").value) + 3;
        const altura = parseFloat(item.querySelector(".altura").value) + 3;
        const qtde = parseInt(item.querySelector(".quantidade").value);
        const preco = parseFloat(item.querySelector(".preco").value);
        const obs = item.querySelector(".obs").value;
        const area = (largura * altura) / 1000000;
        const areaTotal = area * qtde;
        const valorTotal = (material.includes("Vinil") && areaTotal < 5 && qtde <= 2000)
          ? 225
          : areaTotal * preco;
        const valorUnitario = (valorTotal / qtde).toFixed(4);

        texto += `Item ${i+1}:%0AMaterial: ${material}%0AAcabamento: ${acabamento}%0ACola: ${cola}%0ACores: ${cor}%0ALargura: ${largura} mm%0AAltura: ${altura} mm%0AQuantidade: ${qtde}%0AValor                  Unitário: R$ ${valorUnitario}%0AValor Total: R$ ${valorTotal.toFixed(2)}`;
        if (obs) texto += `%0AObs: ${obs}`;
        texto += `%0A%0A`;
      });

      // Termos e Condições e OBS gerais no WhatsApp
      const validade = document.getElementById("validadeProposta").value;
      const prazoEntrega = document.getElementById("prazoEntrega").value;
      const condPagamento = document.getElementById("condPagamento").value;
      const frete = document.getElementById("frete").value;
      const contato = document.getElementById("contatoComercial").value;
      const obsGerais = document.getElementById("obsGerais").value.split("\n").join("%0A");

      texto += `Termos e Condições de Venda:%0AValidade da Proposta: ${validade}%0APrazo                  de Entrega: ${prazoEntrega}%0ACondição de Pagamento: ${condPagamento}%0AFrete: ${frete}%0AContato Comercial:                  ${contato}%0A%0AOBS:%0A${encodeURI(obsGerais)}%0A`;

      texto = encodeURI(texto.trim());
      const url = `https://wa.me/?text=${texto}`;
      const btn = document.getElementById("btnWhats");
      btn.href = url;
      btn.style.display = "block";
    }

    async function gerarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const nome = document.getElementById("nomeCliente").value;
      const email = document.getElementById("emailCliente").value;
      const numOrcamento = document.getElementById("numOrcamento").value;

      // Cabeçalho
      doc.setFontSize(14);
      doc.text(`Orçamento Nº ${numOrcamento}`, 20, 20);
      doc.setFontSize(11);
      doc.text(`Cliente: ${nome}`, 20, 28);
      doc.text(`Email: ${email}`, 20, 34);

      let y = 44;
      // Itens
      document.querySelectorAll(".item").forEach((item, i) => {
        const material = item.querySelector(".material").value;
        const acabamento = item.querySelector(".acabamento").value;
        const cola = item.querySelector(".cola").value;
        const cor = item.querySelector(".cores").value;
        const largura = parseFloat(item.querySelector(".largura").value) + 3;
        const altura = parseFloat(item.querySelector(".altura").value) + 3;
        const qtde = parseInt(item.querySelector(".quantidade").value);
        const preco = parseFloat(item.querySelector(".preco").value);
        const obs = item.querySelector(".obs").value;
        const area = (largura * altura) / 1000000;
        const areaTotal = area * qtde;
        const valorTotal = (material.includes("Vinil") && areaTotal < 5 && qtde <= 2000)
          ? 225
          : areaTotal * preco;
        const valorUnitario = (valorTotal / qtde).toFixed(4);

        // Se ultrapassar a área de impressão, começa nova página
        if (y > 250) {
          doc.addPage();
          y = 20;
        }

        doc.setFont("Helvetica", "bold");
        doc.text(`Item ${i + 1}`, 20, y); y += 6;
        doc.setFont("Helvetica", "normal");
        doc.text(`Material: ${material}`, 20, y); y += 6;
        doc.text(`Acabamento: ${acabamento}`, 20, y); y += 6;
        doc.text(`Tipo de Cola: ${cola}`, 20, y); y += 6;
        doc.text(`Cores: ${cor}`, 20, y); y += 6;
        doc.text(`Largura: ${largura} mm`, 20, y); y += 6;
        doc.text(`Altura: ${altura} mm`, 20, y); y += 6;
        doc.text(`Quantidade: ${qtde}`, 20, y); y += 6;
        doc.text(`Valor Unitário: R$ ${valorUnitario}`, 20, y); y += 6;
        doc.text(`Valor Total do Item: R$ ${valorTotal.toFixed(2)}`, 20, y); y += 6;
        if (obs) {
          doc.text(`Observação: ${obs}`, 20, y);
          y += 6;
        }

        const imgData = imagens[i];
        if (imgData) {
          doc.addImage(imgData, "JPEG", 140, y - 36, 50, 30);
        }
        y += 10;
      });

      // Linha divisória antes dos termos
      if (y > 250) {
        doc.addPage();
        y = 20;
      }
      doc.setDrawColor(0);
      doc.setLineWidth(0.5);
      doc.line(20, y, 190, y);
      y += 8;

      // Termos e Condições
      const validade = document.getElementById("validadeProposta").value;
      const prazoEntrega = document.getElementById("prazoEntrega").value;
      const condPagamento = document.getElementById("condPagamento").value;
      const frete = document.getElementById("frete").value;
      const contato = document.getElementById("contatoComercial").value;
      const obsGerais = document.getElementById("obsGerais").value.split("\n");

      doc.setFontSize(12);
      doc.setFont("Helvetica", "bold");
      doc.text("TERMOS E CONDIÇÕES DE VENDA:", 20, y); y += 6;
      doc.setFont("Helvetica", "normal");
      doc.text(`Validade da Proposta: ${validade}`, 20, y); y += 6;
      doc.text(`Prazo de Entrega (dias úteis): ${prazoEntrega}`, 20, y); y += 6;
      doc.text(`Condição de Pagamento: ${condPagamento}`, 20, y); y += 6;
      doc.text(`Frete: ${frete}`, 20, y); y += 6;
      doc.text(`Contato Comercial: ${contato}`, 20, y); y += 10;

      // Linha divisória antes de OBS
      if (y > 250) {
        doc.addPage();
        y = 20;
      }
      doc.setLineWidth(0.5);
      doc.line(20, y, 190, y);
      y += 8;

      // OBS gerais
      doc.setFont("Helvetica", "bold");
      doc.setTextColor(255, 0, 0); // texto em vermelho
      doc.text("OBS:", 20, y); y += 6;
      doc.setFont("Helvetica", "normal");
      obsGerais.forEach(line => {
        if (y > 260) {
          doc.addPage();
          y = 20;
        }
        doc.text(`• ${line}`, 20, y);
        y += 6;
      });
      doc.setTextColor(0, 0, 0); // volta ao preto para o rodapé

      // Linha final
      if (y > 250) {
        doc.addPage();
        y = 20;
      }
      doc.setLineWidth(0.5);
      doc.line(20, y, 190, y);

      doc.save(`Orcamento_${numOrcamento}.pdf`);
    }

    window.onload = () => {
      gerarNumeroOrcamento();
      adicionarItem(); // já cria o primeiro item
    };
  </script>
</body>
</html>
