<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Orçamento com Arte – Diff Label</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Container centralizado */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f0f0;
    }
    .wrapper {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }

    .item {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      background: #fafafa;
    }

    .item h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      color: #333;
    }

    button {
      margin-top: 15px;
      padding: 12px 20px;
      background-color: #1a73e8;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #0f5cc8;
    }
    #resultado {
      margin-top: 20px;
      padding: 15px;
      background: #eef;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.5;
    }

    /* Botão de WhatsApp */
    a#btnWhats {
      display: none;
      margin-top: 15px;
      text-align: center;
      text-decoration: none;
      background-color: #25D366;
      color: white;
      padding: 12px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 16px;
    }
    a#btnWhats:hover {
      background-color: #1ebe5c;
    }

    /* Ajuste de espaços para textarea */
    textarea.obs {
      resize: vertical;
      min-height: 40px;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Orçamento com Arte – Diff Label</h1>

    <label>Nº do Orçamento:</label>
    <input type="text" id="numOrcamento" readonly />

    <label>Nome do Cliente:</label>
    <input type="text" id="nomeCliente" required />

    <label>E-mail:</label>
    <input type="email" id="emailCliente" required />

    <div id="itensContainer"></div>

    <button onclick="adicionarItem()">Adicionar Item</button>
    <button onclick="calcularOrcamento()">Calcular Orçamento + Gerar PDF</button>
    <button onclick="gerarPDF()">Gerar PDF (sem recálculo)</button>
    <a id="btnWhats" target="_blank">Enviar via WhatsApp</a>

    <div id="resultado"></div>
  </div>

  <script>
    let contador = 0;
    const imagens = [];
    const materiais = [
      "Ad Couche",
      "Bopp Branco Fosco",
      "Bopp Brilho",
      "Bopp Metalizado",
      "Bopp Transparente",
      "Bopp Holográfico",
      "Vinil Fosco",
      "Vinil Amarelo",
      "Vinil Preto",
      "Vinil Brilho",
      "Vinil Refletivo",
      "Vinil Transparente"
    ];
    const acabamentos = [
      "Em Cartela",
      "Em Rolo/Bobina",
      "Rolo/Bobina com Laminação Fosca",
      "Rolo/Bobina com Laminação Brilho"
    ];
    const colas = [
      "Cola Acrílica",
      "Cola Borracha",
      "Cola Removível"
    ];
    const cores = [
      "1x0 (Preto)",
      "4x0 (CMYK)",
      "5x0 (CMYK + Branco)"
    ];

    function gerarNumeroOrcamento() {
      let ultimoNumero = localStorage.getItem('ultimoOrcamento') || 0;
      ultimoNumero = parseInt(ultimoNumero) + 1;
      localStorage.setItem('ultimoOrcamento', ultimoNumero);
      document.getElementById('numOrcamento').value = String(ultimoNumero).padStart(4, '0');
    }

    function criarSelect(options) {
      return options.map(o => `<option>${o}</option>`).join("");
    }

    function adicionarItem() {
      const container = document.getElementById("itensContainer");
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <h3>Item ${contador + 1}</h3>
        <label>Material:</label>
        <select class="material">${criarSelect(materiais)}</select>
        <label>Acabamento:</label>
        <select class="acabamento">${criarSelect(acabamentos)}</select>
        <label>Tipo de Cola:</label>
        <select class="cola">${criarSelect(colas)}</select>
        <label>Cores:</label>
        <select class="cores">${criarSelect(cores)}</select>
        <label>Largura (mm):</label>
        <input type="number" class="largura" required />
        <label>Altura (mm):</label>
        <input type="number" class="altura" required />
        <label>Quantidade:</label>
        <input type="number" class="quantidade" required />
        <label>Preço por m² (R$):</label>
        <input type="number" class="preco" step="0.01" required />
        <label>Observação:</label>
        <textarea class="obs"></textarea>
        <label>Arte (imagem):</label>
        <input type="file" class="arte" accept="image/*" onchange="carregarImagem(this, ${contador})" />
      `;
      container.appendChild(div);
      imagens.push(null);
      contador++;
    }

    function carregarImagem(input, index) {
      const reader = new FileReader();
      reader.onload = () => imagens[index] = reader.result;
      if (input.files[0]) reader.readAsDataURL(input.files[0]);
    }

    function calcularOrcamento() {
      renderizarResultado();
      gerarLinkWhatsApp();
      gerarPDF();
    }

    function renderizarResultado() {
      const nome = document.getElementById("nomeCliente").value;
      const email = document.getElementById("emailCliente").value;
      const numOrcamento = document.getElementById("numOrcamento").value;
      const itens = document.querySelectorAll(".item");
      let totalGeral = 0;
      let resultadoHTML = `
        <h3>Orçamento #${numOrcamento}</h3>
        <p>Cliente: ${nome}<br>Email: ${email}</p>
        <ul>
      `;

      itens.forEach((item, i) => {
        const material = item.querySelector(".material").value;
        const acabamento = item.querySelector(".acabamento").value;
        const cola = item.querySelector(".cola").value;
        const cor = item.querySelector(".cores").value;
        const largura = parseFloat(item.querySelector(".largura").value) + 3;
        const altura = parseFloat(item.querySelector(".altura").value) + 3;
        const qtde = parseInt(item.querySelector(".quantidade").value);
        const preco = parseFloat(item.querySelector(".preco").value);
        const obs = item.querySelector(".obs").value;
        const area = (largura * altura) / 1000000; // mm² → m²
        const areaTotal = area * qtde;
        const valorTotal = (material.includes("Vinil") && areaTotal < 5 && qtde <= 2000)
          ? 225
          : areaTotal * preco;

        totalGeral += valorTotal;

        resultadoHTML += `
          <li>
            <strong>Item ${i + 1}:</strong> ${material}, ${acabamento}, ${cola}, ${cor}, 
            ${largura}×${altura} mm, Qtde: ${qtde}, Área: ${areaTotal.toFixed(2)} m², 
            Valor: R$ ${valorTotal.toFixed(2)}<br>
            <em>${obs}</em>
          </li>`;
      });

      resultadoHTML += `</ul><h4>Total Geral: R$ ${totalGeral.toFixed(2)}</h4>`;
      document.getElementById("resultado").innerHTML = resultadoHTML;
    }

    function gerarLinkWhatsApp() {
      const numOrcamento = document.getElementById("numOrcamento").value;
      const nome = document.getElementById("nomeCliente").value;
      const itens = document.querySelectorAll(".item");
      let texto = `Orçamento #${numOrcamento}%0ACliente: ${nome}%0A`;

      itens.forEach((item, i) => {
        const material = item.querySelector(".material").value;
        const acabamento = item.querySelector(".acabamento").value;
        const cola = item.querySelector(".cola").value;
        const cor = item.querySelector(".cores").value;
        const largura = parseFloat(item.querySelector(".largura").value) + 3;
        const altura = parseFloat(item.querySelector(".altura").value) + 3;
        const qtde = parseInt(item.querySelector(".quantidade").value);
        const preco = parseFloat(item.querySelector(".preco").value);
        const obs = item.querySelector(".obs").value;
        const area = (largura * altura) / 1000000;
        const areaTotal = area * qtde;
        const valorTotal = (material.includes("Vinil") && areaTotal < 5 && qtde <= 2000)
          ? 225
          : areaTotal * preco;

        texto += `Item ${i+1}: ${material}, ${acabamento}, ${cola}, ${cor}, ${largura}×${altura} mm, Qtde: ${qtde}, Área: ${areaTotal.toFixed(2)} m², Valor: R$ ${valorTotal.toFixed(2)}`;
        if (obs) {
          texto += `%0A  Obs: ${obs}`;
        }
        texto += `%0A`;
      });

      // Remove espaços duplicados e codifica
      texto = encodeURI(texto.trim());
      const url = `https://wa.me/?text=${texto}`;
      const btn = document.getElementById("btnWhats");
      btn.href = url;
      btn.style.display = "block";
    }

    async function gerarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const nome = document.getElementById("nomeCliente").value;
      const email = document.getElementById("emailCliente").value;
      const numOrcamento = document.getElementById("numOrcamento").value;

      doc.setFontSize(14);
      doc.text(`Orçamento Nº ${numOrcamento}`, 20, 20);
      doc.setFontSize(11);
      doc.text(`Cliente: ${nome}`, 20, 28);
      doc.text(`Email: ${email}`, 20, 34);
      let y = 44;

      document.querySelectorAll(".item").forEach((item, i) => {
        const material = item.querySelector(".material").value;
        const acabamento = item.querySelector(".acabamento").value;
        const cola = item.querySelector(".cola").value;
        const cor = item.querySelector(".cores").value;
        const largura = parseFloat(item.querySelector(".largura").value) + 3;
        const altura = parseFloat(item.querySelector(".altura").value) + 3;
        const qtde = parseInt(item.querySelector(".quantidade").value);
        const preco = parseFloat(item.querySelector(".preco").value);
        const obs = item.querySelector(".obs").value;
        const area = (largura * altura) / 1000000;
        const areaTotal = area * qtde;
        const valorTotal = (material.includes("Vinil") && areaTotal < 5 && qtde <= 2000)
          ? 225
          : areaTotal * preco;

        // Se estiver perto do fim da página, cria nova página
        if (y > 260) {
          doc.addPage();
          y = 20;
        }

        doc.setFont("Helvetica", "bold");
        doc.text(`Item ${i + 1}`, 20, y);
        y += 6;
        doc.setFont("Helvetica", "normal");
        doc.text(`Material: ${material}, Acabamento: ${acabamento}`, 20, y); y += 6;
        doc.text(`Cola: ${cola}, Cores: ${cor}`, 20, y); y += 6;
        doc.text(`Tamanho: ${largura} × ${altura} mm, Qtde: ${qtde}`, 20, y); y += 6;
        doc.text(`Área total: ${areaTotal.toFixed(2)} m²`, 20, y); y += 6;
        doc.text(`Valor: R$ ${valorTotal.toFixed(2)}`, 20, y); y += 6;
        if (obs) {
          doc.text(`Obs: ${obs}`, 20, y);
          y += 6;
        }

        const imgData = imagens[i];
        if (imgData) {
          // Insere imagem no canto direito, tamanho 50×30 mm
          doc.addImage(imgData, "JPEG", 140, y - 36, 50, 30);
        }
        y += 10;
      });

      doc.save(`Orcamento_${numOrcamento}.pdf`);
    }

    window.onload = () => {
      gerarNumeroOrcamento();
      adicionarItem(); // já cria o primeiro item
    };
  </script>
</body>
</html>
